name: بث مباشر RTMP دائم 1080p60 HQ

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  live-stream:
    runs-on: ubuntu-latest

    steps:
      - name: تثبيت FFmpeg والخطوط
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-dejavu

      - name: بدء البث المستمر بجودة عالية
        run: |
          # إعداد المتغيرات
          INPUT="http://ugeen.live:8080/live/Ugeen_VIPdHi95o/eoKGvj/459.ts"
          OUTPUT="rtmp://vsu.okcdn.ru/input/9585026080287_8946523310623_kilm7b4gee"
          
          # إعدادات الجودة
          # تم اختيار preset veryfast لأن سيرفرات جيثب قد لا تتحمل medium مع 60 فريم
          # ولكن تم تعويض ذلك برفع البت ريت
          
          while true; do
            echo "==============================="
            echo "بدء محاولة بث فائقة الجودة في $(date -u)"
            echo "==============================="

            ffmpeg -re \
              -user_agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
              -thread_queue_size 1024 \
              -fflags +genpts -rtbufsize 200M -timeout 10000000 \
              -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
              -i "$INPUT" \
              -vf "scale=1920:1080:flags=lanczos,drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:text='7esentv.com':fontcolor=white@0.8:fontsize=30:borderw=1:bordercolor=black:x=20:y=main_h-60" \
              -c:v libx264 -preset veryfast -profile:v high -level:v 4.2 \
              -b:v 8500k -maxrate 8500k -bufsize 17000k \
              -g 120 -keyint_min 120 \
              -r 60 \
              -c:a aac -b:a 192k -ar 48000 -ac 2 \
              -f flv "$OUTPUT" \
              -loglevel error \
              -hide_banner \
              -stats

            echo "حدث خطأ أو انقطع الاتصال، إعادة المحاولة بعد 5 ثواني..."
            sleep 5
          done
