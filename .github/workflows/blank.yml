name: بث مباشر RTMP دائم

on:
  workflow_dispatch:

jobs:
  live-stream:
    runs-on: ubuntu-latest

    steps:
      # استخدم prebuilt FFmpeg image لتوفير الوقت
      - name: استخدم Docker FFmpeg جاهز
        uses: addnab/docker-run-action@v4
        with:
          image: jrottenberg/ffmpeg:6.0-ubuntu
          options: --rm
          run: |
            INPUT="https://ab.footballii.ir/hls2/bein1_src.m3u8"
            OUTPUT="rtmp://vsu.okcdn.ru/input/10237855538790_8860754578022_h5fia4qh44"

            # تثبيت Fontconfig والخطوط مرة واحدة
            apt-get update
            apt-get install -y fontconfig fonts-dejavu-core

            while true; do
              echo "==============================="
              echo "بدء محاولة بث جديدة في $(date -u)"
              echo "==============================="

              ffmpeg -re \
                -user_agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
                -fflags +genpts -rtbufsize 100M -timeout 5000000 \
                -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
                -i "$INPUT" \
                -filter_complex "[0:v]fps=30,scale=1280:720, \
                  drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:text='حمل تطبيقنا من':fontcolor=white@0.6:fontsize=22:shadowcolor=black@0.4:shadowx=2:shadowy=2:x=15:y=main_h-80, \
                  drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:text='7esentv.com':fontcolor=white:fontsize=26:borderw=2:bordercolor=black:x=15:y=main_h-50[v_out]" \
                -map "[v_out]" -map 0:a \
                -c:v libx264 -preset veryfast -tune zerolatency -pix_fmt yuv420p \
                -c:a aac -b:a 128k -ar 44100 \
                -f flv "$OUTPUT" \
                -loglevel error \
                -hide_banner \
                -stats

              echo "حدث خطأ أو انتهى البث، إعادة المحاولة بعد 10 ثواني..."
              sleep 10
            done
